name: ci

on:
  push:
    branches:
      - main
      - next
  pull_request:

jobs:
  policy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify manifest policy
        shell: pwsh
        run: ./ci/verify_manifest.ps1

      - name: Verify seed metadata
        shell: pwsh
        run: ./ci/verify_seed_hash.ps1

      - name: Enforce no external toolchain references
        shell: pwsh
        run: ./ci/forbid_external_toolchain.ps1

      - name: Emit minimal ELF sample
        shell: pwsh
        run: ./compiler/finc/stage0/emit_elf_exit0.ps1 -OutFile artifacts/fin-elf-exit0

      - name: Verify minimal ELF sample
        shell: pwsh
        run: ./tests/bootstrap/verify_elf_exit0.ps1 -Path artifacts/fin-elf-exit0

      - name: Verify stage0 grammar fixtures
        shell: pwsh
        run: ./tests/conformance/verify_stage0_grammar.ps1

      - name: Build stage0 fixture via fin CLI
        shell: pwsh
        run: ./cmd/fin/fin.ps1 build --src tests/conformance/fixtures/main_exit7.fn --out artifacts/fin-build-exit7

      - name: Verify built stage0 fixture
        shell: pwsh
        run: ./tests/bootstrap/verify_elf_exit0.ps1 -Path artifacts/fin-build-exit7 -ExpectedExitCode 7

      - name: Collect changed files
        if: github.event_name == 'pull_request'
        id: changed
        shell: pwsh
        run: |
          $base = "${{ github.event.pull_request.base.sha }}"
          $head = "${{ github.sha }}"
          $files = git diff --name-only $base $head
          "files<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          $files | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Enforce FIP link for feature changes
        if: github.event_name == 'pull_request'
        shell: pwsh
        run: |
          ./ci/check_fip_link.ps1 `
            -Title "${{ github.event.pull_request.title }}" `
            -Body "${{ github.event.pull_request.body }}" `
            -ChangedFiles "${{ steps.changed.outputs.files }}"
